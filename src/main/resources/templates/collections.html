<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Collection Api</title>
        <link rel="stylesheet" style="text/css" href="/editor/dependencies/fontawesome/css/all.css" />
        <link href="/editor/dependencies/tabulator/css/tabulator_bootstrap4.min.css" rel="stylesheet">
        <link rel="stylesheet" style="text/css" href="/editor/dependencies/jsonform/deps/opt/bootstrap-v4.5.2.css"/>
        <link rel="stylesheet" style="text/css" href="/editor/lib/css/metadataeditor.style.default.css" />
    </head>
    <body>
        <div class="container">
            <div class="col-12">
                <!-- table-->
                <div>
                    <h4 class ="table-title">Collection Api</h4>
                    <div id="table"></div>
                </div>

                <!-- form-->
                <div class="modal fade form-modal" id="formModal" data-keyboard="false" data-backdrop="static">
                    <div class="modal-dialog">

                        <div class="modal-content">
                            <div class="modal-header">
                                <h4>Collection</h4>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">&times;</button>
                            </div>
                            <div class="modal-body">
                                <form ></form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script type="text/javascript" src="/editor/dependencies/jsonform/deps/jquery-v3.5.1.min.js"></script>
        <script type="text/javascript" src="/editor/dependencies/bootstrap/js/bootstrap-v4.5.3.min.js"></script>
        <script type="text/javascript" src="/editor/dependencies/jsonform/deps/underscore.js"></script>
        <script type="text/javascript" src="/editor/dependencies/jsonform/deps/opt/jsv.js"></script>
        <script type="text/javascript" src="/editor/dependencies/jsonform/lib/jsonform.js"></script>
        <script type="text/javascript" src="/editor/dependencies/tabulator/js/tabulator.min.js"></script>
        <script type="text/javascript" src="/editor/lib/js/metadataeditor.js"></script>

        <script th:inline="javascript">

            var options;
            /*<![CDATA[*/
            options = /*[[${request}]]*/ {};
            /*]]>*/

            // add modals to html
            $('body').append(modalTemplate("ALERT"));
            $('body').append(modalTemplate("FAILED"));
            $('body').append(modalTemplate("SUCCESS"));

            var inputs = {dataModel: options.dataModel, uiForm: options.uiForm, resource: options.collections, items: options.items};
            $('#table').metadataeditorTable(inputs,
                    //form filled with values will be shown. The user cannot edit the form.
                            function readOperation(value) {
                                var options = {operation: "READ", dataModel: inputs.dataModel, uiForm: inputs.uiForm, resource: value};
                                $('form').metadataeditorForm(options, function onSubmitValid(value) {
                                });
                                $("#formModal").modal('show');
                            },
                            //form filled with values will be shown. The user has the possibility to update the collection.
                                    function editOperation(value) {
                                        var options = {operation: "UPDATE", dataModel: inputs.dataModel, uiForm: inputs.uiForm, resource: value};
                                        $('form').metadataeditorForm(options, function onSubmitValid(value) {
                                            updateCollection(value);
                                        });
                                        $("#formModal").modal('show');
                                    },
                                    //form filled with read-only values will be shown. The user can delete the collection.
                                            function deleteOperation(value) {
                                                var options = {operation: "DELETE", dataModel: inputs.dataModel, uiForm: inputs.uiForm, resource: value};
                                                $('form').metadataeditorForm(options, function onSubmitValid(value) {
                                                    deleteCollection(value);
                                                });
                                                $("#formModal").modal('show');
                                            },
                                            //empty form will be shown. The user has the possibility to fill the form and create a new collection.
                                                    function createOperation() {
                                                        var options = {operation: "CREATE", dataModel: inputs.dataModel, uiForm: inputs.uiForm};
                                                        $('form').metadataeditorForm(options, function onSubmitValid(value) {
                                                            createCollection(value);
                                                        });
                                                        $("#formModal").modal('show');
                                                    });

                                            /**
                                             * generates the appropriate etag and updates the collection with the new json value.
                                             * @param {type} value the new json value
                                             * @returns {undefined}
                                             */
                                            function updateCollection(value) {
                                                generateEtag(value, function (status, etag) {
                                                    if (status === "success") {
                                                        $.ajax({
                                                            type: "PUT",
                                                            url: "/api/v1/collections/" + JSON.parse(value).id,
                                                            dataType: "json",
                                                            contentType: "application/json",
                                                            "headers": {
                                                                "If-Match": etag
                                                            },
                                                            data: value,
                                                            success: function (result) {
                                                                $("#formModal").modal('hide');
                                                                showModal("SUCCESS", "Operation has been sucessfully executed!", "/collections");
                                                            },
                                                            error: function (result) {
                                                                $("#formModal").modal('hide');
                                                                showModal("FAILED", "Operation failed: Error: " + result.status, "");
                                                            }
                                                        });
                                                    } else {
                                                        alert("etag couldn't be generated");
                                                    }
                                                });

                                            }

                                            /**
                                             * generates the appropriate etag and deletes the collection.
                                             * @param {type} value JSON value, which represents the collection that should be deleted.
                                             * @returns {undefined}
                                             */
                                            function deleteCollection(value) {
                                                generateEtag(value, function (status, etag) {
                                                    if (status === "success") {
                                                        $.ajax({
                                                            type: "DELETE",
                                                            url: "/api/v1/collections/" + JSON.parse(value).id,
                                                            dataType: "json",
                                                            contentType: "application/json",
                                                            "headers": {
                                                                "If-Match": etag
                                                            },
                                                            data: value,
                                                            success: function (result) {
                                                                $("#formModal").modal('hide');
                                                                showModal("SUCCESS", "Operation has been sucessfully executed!", "/collections");
                                                            },
                                                            error: function (result) {
                                                                $("#formModal").modal('hide');
                                                                showModal("FAILED", "Operation failed: Error: " + result.status, "");
                                                            }
                                                        });
                                                    } else {
                                                        alert("etag couldn't be generated");
                                                    }
                                                });
                                            }

                                            /**
                                             * creates a new collection.
                                             * @param {type} value JSOn Value, which represents the collection that should be created.
                                             * @returns {undefined}
                                             */
                                            function createCollection(value) {
                                                $.ajax({
                                                    type: "POST",
                                                    url: "/api/v1/collections",
                                                    dataType: "json",
                                                    contentType: "application/json",
                                                    data: "[" + value + "]",
                                                    success: function (result) {
                                                        $("#formModal").modal('hide');
                                                        showModal("SUCCESS", "Operation has been sucessfully executed!", "/collections");
                                                    },
                                                    error: function (result) {
                                                        $("#formModal").modal('hide');
                                                        showModal("FAILED", "Operation failed: Error: " + result.status, "");
                                                    }
                                                });
                                            }

                                            /**
                                             * returns the etag of a collection.
                                             * @param {type} value represents a collection as a JSON value
                                             * @param {type} callback cb function returns the etag value in case the actual method is coorectly executed.
                                             * @returns {undefined}
                                             */
                                            function generateEtag(value, callback) {
                                                $.ajax({
                                                    type: "GET",
                                                    url: "/api/v1/collections/" + JSON.parse(value).id,
                                                    dataType: "json",
                                                    contentType: "application/json",
                                                    success: function (output, status, xhr) {
                                                        callback(status, xhr.getResponseHeader("etag"));
                                                    },
                                                    error: function (result) {
                                                        callback(result.status);
                                                    }
                                                });
                                            }
        </script>
    </body>
</html>